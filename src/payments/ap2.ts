import { z } from 'zod'; import { SignJWT, importPKCS8 } from 'jose'; export const Mandate=z.object({issuerDID:z.string(),subjectDID:z.string(),scope:z.enum(['TIP','PURCHASE','SUBSCRIPTION']),maxAmountMinor:z.number().int().positive(),currency:z.string(),expiresAt:z.number().int()}); export type Mandate=z.infer<typeof Mandate>; export const Intent=z.object({amountMinor:z.number().int().positive(),currency:z.string(),memo:z.string().optional(),counterparty:z.string(),rail:z.enum(['X402','CARD'])}); export type Intent=z.infer<typeof Intent>; export async function signMandateJWT(m:Mandate,pem:string){ const pk=await importPKCS8(pem,'EdDSA'); return await new SignJWT({m}).setProtectedHeader({alg:'EdDSA',typ:'JWT'}).setIssuer(m.issuerDID).setSubject(m.subjectDID).setExpirationTime(Math.floor(m.expiresAt/1000)).sign(pk) }